{% extends "layout.html" %}
{% block content %}

<section id="simulate" class="mb-5">
  <div class="dashboard-card mb-4">
    <div class="card-header">
      <h5>ROI 시뮬레이션</h5>
    </div>

    <div class="card-body">
      <div class="row text-center mb-4">
        <div class="col-md-6">
          <p class="text-muted">예상 매출액 (변경 후)</p>
          <h4 id="result-revenue"></h4>
        </div>
        <div class="col-md-6">
          <p class="text-muted">예상 ROI (변경 후)</p>
          <h4 id="result-roi"></h4>
        </div>
      </div>

      <div class="row text-center mb-4">
        <div class="col-md-6">
          <p class="text-muted">매출 변화량</p>
          <h4 id="result-revenue-change"></h4>
        </div>
        <div class="col-md-6">
          <p class="text-muted">ROI 변화량</p>
          <h4 id="result-roi-change"></h4>
        </div>
      </div>

      <div id="simChart"></div>
    </div>
  </div>
</section>

<section id="simulate" class="mb-5">
  <div class="dashboard-card mb-4">
    <div class="card-header">
      <h5>결과 해석</h5>
    </div>

    <textarea id="result_analysis" class="form-control mt-4" rows="4"
              placeholder="결과 해석이 여기에 표시됩니다"></textarea>
  </div>
</section>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="/static/js/chatbot.js"></script>

<script>
  const INTERCEPT = Number("{{ INTERCEPT }}");
  const SEARCH_COEFF = Number("{{ SEARCH_COEFF }}");
  const LIVE_COEFF = Number("{{ LIVE_COEFF }}");
  const EVENT_COEFF = Number("{{ EVENT_COEFF }}");

  const base_search = Number("{{ base_search }}") || 0;
  const base_live = Number("{{ base_live }}") || 0;
  const new_search = Number("{{ new_search }}") || 0;
  const new_live = Number("{{ new_live }}") || 0;

  const promo_flag_base = Number("{{ promo_flag_base }}") || 0;
  const promo_flag_new = Number("{{ promo_flag_new }}") || 0;

  function calcRevenue(costS, costL, eventFlag) {
    const revenue =
      INTERCEPT +
      SEARCH_COEFF * costS +
      LIVE_COEFF * costL +
      EVENT_COEFF * eventFlag;

    const totalCost = costS + costL;
    const roi = (revenue - totalCost) / (totalCost !== 0 ? totalCost : 1);
    return { revenue, roi };
  }

  const base = calcRevenue(base_search, base_live, promo_flag_base);
  const mod = calcRevenue(new_search, new_live, promo_flag_new);

  const baseRevenue = base.revenue;
  const newRevenue = mod.revenue;
  const baseRoi = base.roi;
  const newRoi = mod.roi;

  const revenueChange = newRevenue - baseRevenue;
  const roiChange = newRoi - baseRoi;

  viewSimulation({
    baseRevenue,
    newRevenue,
    baseRoi,
    newRoi,
    revenueChange,
    roiChange,
    base_search_ad_cost: base_search,
    base_live_ad_cost: base_live,
    new_search_ad_cost: new_search,
    new_live_ad_cost: new_live,
    base_promo_flag: promo_flag_base,
    new_promo_flag: promo_flag_new
  });
</script>

{% endblock %}
